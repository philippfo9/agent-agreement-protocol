generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Store agreement metadata that shouldn't be on-chain (private agreements, documents)
model Agreement {
  id              String   @id @default(cuid())
  agreementPda    String   @unique // On-chain PDA
  agreementIdHex  String   // Hex of the 16-byte agreement ID
  visibility      Int      @default(0) // 0=public, 1=private
  
  // Document storage
  documentKey     String?  // R2 key for uploaded document
  documentName    String?  // Original filename
  documentHash    String?  // SHA-256 hex
  
  // Terms text (for private agreements, stored off-chain)
  termsText       String?  
  
  // Parties (wallet pubkeys that can view this agreement)
  parties         AgreementParty[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([agreementPda])
}

model AgreementParty {
  id            String    @id @default(cuid())
  agreementId   String
  agreement     Agreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)
  walletPubkey  String    // The wallet that can view this agreement
  role          String    @default("party") // proposer, counterparty
  
  @@unique([agreementId, walletPubkey])
  @@index([walletPubkey])
}

// Agent policy constraints (prenup)
model AgentPolicy {
  id                    String   @id @default(cuid())
  agentPubkey           String   // the agent identity pubkey
  authorityWallet       String   // human wallet that set this policy
  
  // Constraints
  allowedTypes          String[] // agreement types: "service", "partnership", "revenue-share", "safe", "custom"
  maxEscrowLamports     BigInt?  // max escrow per agreement (null = no limit)
  maxActiveAgreements   Int?     // max concurrent agreements (null = no limit)
  requireHumanCosign    Boolean  @default(false) // if true, agent proposals need human approval
  maxDurationDays       Int?     // max agreement duration in days (null = no limit)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@unique([agentPubkey])
}

// Draft agreements pending human approval
model DraftAgreement {
  id                    String   @id @default(cuid())
  agentPubkey           String   // proposing agent
  authorityWallet       String   // human who needs to approve
  
  // Agreement details (mirrors on-chain fields)
  agreementType         String
  counterpartyPubkey    String?
  termsHash             String
  termsUri              String?
  isPublic              Boolean  @default(true)
  escrowAmount          BigInt?
  durationDays          Int?
  title                 String?
  description           String?
  
  status                String   @default("pending") // pending, approved, rejected, expired
  rejectionReason       String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// Signature display names for humans
model SignerProfile {
  id            String   @id @default(cuid())
  walletPubkey  String   @unique
  displayName   String   // Human-readable name for signatures
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
